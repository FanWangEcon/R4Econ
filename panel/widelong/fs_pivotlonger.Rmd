---
title: "Convert Table from Wide to Long with dplyr"
titleshort: "Convert Table from Wide to Long with dplyr"
description: |
  Given a matrix of values with row and column labels, create a table where the unit of observation are the row and column categories, and the values in the matrix is stored in a single variable.
core:
  - package: tidyr
    code: |
      pivot_longer(cols = starts_with('zi'), names_to = c('zi'), names_pattern = paste0("zi(.)"), values_to = "ev")
  - package: dplyr
    code: |
      left_join()
date: 2022-07-16
date_start: 2020-05-14
output:
  pdf_document:
    pandoc_args: '../../_output_kniti_pdf.yaml'
    includes:
      in_header: '../../preamble.tex'
  html_document:
    pandoc_args: '../../_output_kniti_html.yaml'
    includes:
      in_header: "../../hdga.html"
always_allow_html: true
urlcolor: blue
---

### Wide to Long

```{r global_options, include = FALSE}
try(source("../../.Rprofile"))
```

`r text_shared_preamble_one`
`r text_shared_preamble_two`
`r text_shared_preamble_thr`

Using the [pivot_wider](https://tidyr.tidyverse.org/reference/pivot_wider.html) function in tidyr to reshape panel or other data structures

#### Wide to Long Panel

We have a matrix of values, the values are *ev*. Each row corresponds to a different value of the *a* variable, each column represents a different value of the *z* variable. 

Based on this matrix, we create a table where each unit of observation is for a specific *a* and *z* variable combination. So the matrix is turned from wide to long. 

The resulting long table has 5 variables 

1. *a*: values of the *a* variable, the original matrix row labels 
2. *ai*: an index from 1, indicating the original matrix row index
3. *z*: values of the *z* variable, the original matrix column lables
4. *zi*: an index from 1, indicating hte original matrix column index

First, we create the matrix. 

```{r}
# Generate A Matrix
set.seed(123)
ar_a <- c(1.1,5.1)
ar_z <- seq(-2.5, 2.53, length.out=11)
mt_ev = matrix(rnorm(ar_a*ar_z), nrow=length(ar_a), ncol=length(ar_z))

# Name Matrix
rownames(mt_ev) <- paste0('ai', seq(1:length(ar_a)))
colnames(mt_ev) <- paste0('zi', seq(1:length(ar_z)))

# to tibble
tb_ev <- as_tibble(mt_ev) %>% rowid_to_column(var = "ai")

# Print
print(mt_ev)
# Display
kable(tb_ev, caption = "Wide table") %>% kable_styling_fc()
```

Second, we convert the table wide to long. 

```{r}

# longer
tb_ev_long <- tb_ev %>%
  pivot_longer(cols = starts_with('zi'),
               names_to = c('zi'),
               names_pattern = paste0("zi(.*)"),
               values_to = "ev") %>%
  mutate(zi = as.numeric(zi))

# Merge with a and z values
tb_ev_long <- tb_ev_long %>%
  left_join(as_tibble(ar_a) %>%
              rowid_to_column(var = "ai") %>%
              rename(a = value)
              , by = 'ai') %>%
  left_join(as_tibble(ar_z) %>%
              rowid_to_column(var = "zi") %>%
              rename(z = value),
            by = 'zi') %>%
  select(a,ai,z,zi,ev)

# Display
kable(tb_ev_long, caption = "Long table") %>% kable_styling_fc()
```

