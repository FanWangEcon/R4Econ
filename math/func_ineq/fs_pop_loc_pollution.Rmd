---
title: "Share of Environmental Exposure Burden Across Population Groups"
titleshort: "Share of Environmental Exposure Burden Across Population Groups"
description: |
  Simulate population distribution by location and demographic groups.
  Simulate pollution exposures by location.
  Compute share of pollution burden for a population group relative to the share of overall population accounted for by this population group.
core:
  - package: r
    code: |
      matrix()
  - package: stats
    code: |
      runif()
      sum()
  - package: dplyr
    code: |
      arrange()
      group_by()
      left_join()
      filter()
      slice()
date: 2021-12-27
date_start: 2021-12-27
output:
  html_document:
    pandoc_args: '../../_output_kniti_html.yaml'
    includes:
      in_header: "../../hdga.html"
  pdf_document:
    pandoc_args: '../../_output_kniti_pdf.yaml'
    includes:
      in_header: '../../preamble.tex'
always_allow_html: true
urlcolor: blue
---

### Location, Population, and Pollution

```{r global_options, include = FALSE}
try(source("../../.Rprofile"))
```

`r text_shared_preamble_one`
`r text_shared_preamble_two`
`r text_shared_preamble_thr`

#### Location, Population, and Environmental Exposures (Pollution)

##### Local Public Exposures $Z_{l,y}$

Environmental exposure, specifically PM 2.5, is a local public good (bad). Prior research has shown that due to the nature of particular matter formation in the air, while there is particular matter variation at the city level, there is not significant variation in particular matter pollution at the neighborhood level [He et al. (2019)](https://www.aeaweb.org/articles?id=10.1257/app.20170286) and [Liu et al. (2022)](https://fanwangecon.github.io/assets/FanWang_PollutionTempBirthweight.pdf). Additionally, there is a difference between ambient environmental exposures and the amount of particular matter inhaled by individual residents: the former is a common level shared by all residents, but the latter can differ depending on individuals' physical and socio-economic attributes. 

There are $M$ different locations (cities/counties/townships), indexed from $l=1$ to $l=M$. In a particular time-period, we assume that the potential pollution exposure for all residents in the same location. Suppose additionally that we compute statistics at the interval of years $y$, and each year includes daily pollution measure for each day of the year $t$, indexed from $t=1$ to $t=T_y$, where $T_y$ is the total number of days in a year. 

Let $\text{Z}_{l,y}$ be the total pollution exposure by a resident in location $l$. This is equal to the sum of pollution exposure during the course of a year: 

$$
Z_{l,y} = \sum_{t=1}^{T_y} Z_{l,y,t}
$$

##### Group Exposures $\mathcal{Z}_{i,y}$

Let there be $N$ population groups, indexed from $i=1$ to $i=N$. The $N$ population groups reside in the $M$ locations. the share, let $P_{l,i}$ denote share of population belong to group $i$ that resides in location $l$:

$$
1 = 
\sum_{l=1}^{M} 
\sum_{i=1}^{N}
P_{l,i}
$$

The share of population belong to population group $i$ is:
$$
P_i = 
\sum_{l=1}^{M} 
P_{l,i}
$$

$\mathcal{Z}_{i,y}$, which is the average pollution exposure facing an individual belonging to group $i$ in year $y$, is determined by how individuals from population group $i$ are distributed across the $M$ locations:

$$
\mathcal{Z}_{i,y} = 
\sum_{l=1}^{M} 
\left(
  \frac{P_{l,i}}{P_i}
  \times
  Z_{l,y}
\right)
$$

Additionally, $\mathcal{Z}_{y}$ is the average pollution exposure facing an individual, regardless of population group, in year $y$:

$$
\mathcal{Z}_{y} = 
\sum_{i=1}^N
\left(
\sum_{l=1}^{M} 
\left(
  \frac{P_{l,i}}{P_i}
  \times
  Z_{l,y}
\right)
P_i
\right)
=
\sum_{i=1}^N
\left(
\sum_{l=1}^{M} 
\left(
  P_{l,i}
  \times
  Z_{l,y}
\right)
\right)
$$


##### Excess Environmental Exposure Burden to Population

We have $\mathcal{Z}_{i,y}$, the average pollution burden facing an individual in a particular population group. We also have $P_i$, the share of population belong to population group $i$. 

How does the share of pollution burden facing a population group relate to the share of population this group has in the overall population? 

We define $\mathcal{E}_{i,y}$ as the share of pollution burden for population group $i$ that is in excess of its population share as: 
$$
\mathcal{E}_{i,y} = 
  \left(
    \frac{\mathcal{Z}_{i,y} \times P_i
    }{
    \sum_{\widehat{i}}^{N}
    \left(
      \mathcal{Z}_{\widehat{i},y}
      \times P_{\widehat{i}}
    \right)
    }
  \right)
  \times 
  \frac{1}{P_i}
  = \frac{
    \mathcal{Z}_{i,y}
    }{
    \sum_{\widehat{i}}^{N}
    \left(
      \mathcal{Z}_{\widehat{i},y}
      \times P_{\widehat{i}}
    \right)
    }
$$


#### Simulate Population Distribution over Location and Demographics

Use the binomial distribution to generate heterogenous demographic break-down by location. There are N demographic cells, and the binomial distribution provides the probability mass in each of the N cell. Different bernoulli "win" chance for each location. There is also probability distribution over population in each location.

First, construct empty population share dataframe:

```{r}
# 7 different age groups and 12 different locationso
it_N_pop_groups <- 7
it_M_location <- 12
# Matrix of demographics by location
mt_pop_data_frac <- matrix(data=NA, nrow=it_M_location, ncol=it_N_pop_groups)
colnames(mt_pop_data_frac) <- paste0('popgrp', seq(1,it_N_pop_groups))
rownames(mt_pop_data_frac) <- paste0('location', seq(1,it_M_location))
# Display
mt_pop_data_frac %>% kable() %>% kable_styling_fc()
```

Second, generate conditional population distribution for each location, and then multiply by the share of population in each locality:

```{r}
# Share of population per location
set.seed(123)
ar_p_loc <- dbinom(0:(3*it_M_location-1), 3*it_M_location-1, 0.5)
it_start <- length(ar_p_loc)/2-it_M_location/2
ar_p_loc <- ar_p_loc[it_start:(it_start+it_M_location+1)]
ar_p_loc <- ar_p_loc/sum(ar_p_loc)

# Different bernoulli "win" probability for each location
set.seed(234)
# ar_fl_unif_prob <- sort(runif(it_M_location)*(0.25)+0.4)
ar_fl_unif_prob <- sort(runif(it_M_location))

# Generate population proportion by locality
for (it_loc in 1:it_M_location ) {
  ar_p_pop_condi_loc <- dbinom(0:(it_N_pop_groups-1), it_N_pop_groups-1, ar_fl_unif_prob[it_loc])
  mt_pop_data_frac[it_loc,] <- ar_p_pop_condi_loc*ar_p_loc[it_loc]
}

# Sum of cells, should equal to 1
print(paste0('pop frac sum = ', sum(mt_pop_data_frac)))

# Display
round(mt_pop_data_frac*100, 2) %>%
  kable(caption='Share of population in each location and demographic cell') %>%
  kable_styling_fc()
```

#### Simulate Environmental Exposure

Use log-normal distribution to describe average daily PM10 exposures distribution by locality:

```{r}
fl_meanlog <- 3.4
fl_sdlog <- 0.35
hist(rlnorm(1000, meanlog = fl_meanlog, sdlog = fl_sdlog))
```

First, draw pollution measure for each locality:

```{r}
# draw
set.seed(123)
ar_pollution_loc <- rlnorm(it_M_location, meanlog = fl_meanlog, sdlog = fl_sdlog)
# pollution dataframe
# 5 by 3 matrix

# Column Names
ar_st_varnames <- c('location','avgdailypm10')

# Combine to tibble, add name col1, col2, etc.
tb_loc_pollution <- as_tibble(ar_pollution_loc) %>%
  rowid_to_column(var = "id") %>%
  rename_all(~c(ar_st_varnames)) %>%
  mutate(location = paste0('location', location))

# Display
kable(tb_loc_pollution) %>% kable_styling_fc()
```

Second, reshape population data:

```{r}
# Reshape population data, so each observation is location/demo
df_pop_data_frac_long <- as_tibble(mt_pop_data_frac, rownames='location') %>%
  pivot_longer(cols = starts_with('popgrp'),
               names_to = c('popgrp'),
               names_pattern = paste0("popgrp(.*)"),
               values_to = "pop_frac")
```

Third, join with pollution data:

```{r}
# Reshape population data, so each observation is location/demo
df_pop_pollution_long <- df_pop_data_frac_long %>%
  left_join(tb_loc_pollution, by='location')

# display
df_pop_pollution_long[1:round(it_N_pop_groups*2.5),] %>% kable() %>% kable_styling_fc()
```

#### Compute Demographic Group Specific Exposure Distributions

What is the p10, median, p90 and mean pollution exposure for each demographic group?

1. group by population group
2. sort by pollution exposure within group
3. generate population group specific conditional population weights
4. generate population CDF for each population group (sorted by pollution)

```{r}
# Follow four steps above
df_pop_pollution_by_popgrp_cdf <- df_pop_pollution_long %>%
  arrange(popgrp, avgdailypm10) %>%
  group_by(popgrp) %>%
  mutate(cdf_pop_condi_popgrp_sortpm10 = cumsum(pop_frac/sum(pop_frac)),
         pmf_pop_condi_popgrp_sortpm10 = (pop_frac/sum(pop_frac)))
# display
df_pop_pollution_by_popgrp_cdf[1:round(it_N_pop_groups*5.5),] %>%
  kable() %>% kable_styling_fc_wide()
```

#### Various Relative Burden Statistics

What to compute?

1. Excess pollution burden: Share of pollution burden by population group and overall population share, this is simply the ratio of population group mean and the overall weighted mean.
2. What is the fraction of the people in each population group with below and above overall average?
3. Merge results for different quantiles together.

##### Excess pollution burden

We compute excess population burden: *pm10_grp_exc_burden*. 0.10 means 10 percent in excess, this means the pollution burden share is 10 percent in excess of the population share. -0.10 means 10 percent less than what population share is.

Additionally, we compute the share of people within group above the overall mean: *pm10_grp_shr_exc*. This shows the share of people having excess burden. This complements the first number. Because the 10 percent excess could be due to very high exposure to a very small number of people within a population group, or it could be that most people in the group are in "excess".

```{r}
# Stats 1: excess pollution burden
df_excess_pollution_burden <- df_pop_pollution_by_popgrp_cdf %>%
  ungroup() %>%
  mutate(pm10_overall_mean = weighted.mean(avgdailypm10, pop_frac)) %>%
  group_by(popgrp) %>%
  mutate(pm10_grp_mean = weighted.mean(avgdailypm10, pop_frac)) %>%
  slice(1) %>%
  mutate(pm10_grp_exc_burden = pm10_grp_mean/pm10_overall_mean - 1) %>%
  select(popgrp, pm10_grp_mean, pm10_overall_mean, pm10_grp_exc_burden)
fl_pm10_overall_mean <- mean(df_excess_pollution_burden %>% pull(pm10_overall_mean))

# Stats 2: share of people within group below or above overall mean
df_share_below_or_excess <- df_pop_pollution_by_popgrp_cdf %>%
  arrange(popgrp, avgdailypm10) %>%
  filter(avgdailypm10 < fl_pm10_overall_mean) %>%
  slice_tail() %>%
  mutate(pm10_grp_shr_exc = 1 - cdf_pop_condi_popgrp_sortpm10) %>%
  select(popgrp, pm10_grp_shr_exc)
# merge stats 2 with stats 1
df_excess_pollution_burden <- df_excess_pollution_burden %>%
  left_join(df_share_below_or_excess, by="popgrp")

# display
df_excess_pollution_burden %>%
  kable(caption = 'PM10 Exposure Distribution by Population Groups') %>%
  kable_styling_fc()
```

##### Within Group Percentiles

Compute within group percentiles for each population groups. Use the list of percentiles below to specify which percentiles should be computed.

```{r}
# Stats 3: percentiles and ratios
ar_fl_percentiles <- c(0.1, 0.2, 0.8, 0.9)
# Stats 3a: generate key within group percentiles
# 1. 20th and 80th percentiles
# 2. 10th and 90th percentiles
# 3. 50th percentile
# Generate pollution quantiles by population groups
for (it_percentile_ctr in seq(1, length(ar_fl_percentiles))) {

    # Current within group percentile to compute
    fl_percentile <- ar_fl_percentiles[it_percentile_ctr]
    svr_percentile <- paste0('pm10_p', round(fl_percentile*100))

    # Frame with specific percentile
    df_within_percentiles_cur <- df_pop_pollution_by_popgrp_cdf %>%
      group_by(popgrp) %>%
      filter(cdf_pop_condi_popgrp_sortpm10 >= fl_percentile) %>%
      slice(1) %>%
      mutate(!!sym(svr_percentile) := avgdailypm10) %>%
      select(popgrp, one_of(svr_percentile))

    # Merge percentile frames together
    if (it_percentile_ctr > 1) {
      df_within_percentiles <- df_within_percentiles %>%
        left_join(df_within_percentiles_cur, by='popgrp')
    } else {
      df_within_percentiles <- df_within_percentiles_cur
    }
}

# display
df_within_percentiles %>%
  kable(caption = 'PM10 Exposure Distribution by Population Groups') %>%
  kable_styling_fc()

```

##### Percentiles As Excess Burden

The 80th percentile for a population group, how is this exposed relative to the mean? We simply divide the within group pollution percentiles by the overall mean across all groups. All are properly weighted.

This is relating within group percentiles to the overall mean. These can be interpreted as excess burdens at specific percentiles. Individuals at the 80th percentile of a particular population group, how does their pollution burden compare to their population share?

```{r}
# merge stats 3 with stats 1 and 2
df_excess_pollution_burden <- df_excess_pollution_burden %>%
  left_join(df_within_percentiles, by="popgrp")

# Stats 3b: Percentiles to Relative Burdens
# Convert percentiles to be relative of overall means
for (it_percentile_ctr in seq(1, length(ar_fl_percentiles))) {

    # Current within group percentile to compute
    fl_percentile <- ar_fl_percentiles[it_percentile_ctr]
    svr_percentile <- paste0('pm10_p', round(fl_percentile*100))
    svr_perc_exc_burden <- paste0('pm10_grp_excbrd_p', round(fl_percentile*100))

    # Percentiles to excess percentiles
    df_excess_pollution_burden  <- df_excess_pollution_burden  %>%
      mutate(!!sym(svr_perc_exc_burden) := !!sym(svr_percentile)/pm10_overall_mean)
}

# display
df_excess_pollution_burden %>%
  select(-pm10_overall_mean,
         -starts_with('pm10_p')) %>%
  kable(caption = 'PM10 Exposure Distribution by Population Groups') %>%
  kable_styling_fc_wide()
```

##### Within Group Relative Exposure Ratios Across Percentiles

We now compute within group relative ratios of interest. This is purely within group inequality.

```{r}
# lower and upper bound or relative within group ratios
# can only use values appearing in the percentiles list prior
ar_fl_ratio_upper <- c(0.8, 0.9)
ar_fl_ratio_lower <- c(0.2, 0.1)
# Stats 4c: Ratios
# Generate P80 to P20 ratio, and P90 to P10 standard inequality ratios
for (it_ratio_ctr in seq(1, length(ar_fl_ratio_upper))) {

    # Upper and lower percentile bounds
    fl_ratio_upper <- ar_fl_ratio_upper[it_ratio_ctr]
    fl_ratio_lower <- ar_fl_ratio_lower[it_ratio_ctr]
    svr_ratio_upper_perc <- paste0('pm10_p', round(fl_ratio_upper*100))
    svr_ratio_lower_perc <- paste0('pm10_p', round(fl_ratio_lower*100))

    # New relative within group ratio variable name
    svr_ratio <- paste0('pm10_rat_p', round(fl_ratio_upper*100), '_dvd_p', round(fl_ratio_lower*100))

    # Generate P80 to P20 ratio, etc.
    df_excess_pollution_burden  <- df_excess_pollution_burden  %>%
      mutate(!!sym(svr_ratio) := !!sym(svr_ratio_upper_perc)/!!sym(svr_ratio_lower_perc))
}

# display
df_excess_pollution_burden %>%
  select(-pm10_overall_mean,
         -starts_with('pm10_grp_excbrd_p'),
         -starts_with('pm10_p')) %>%
  kable(caption = 'PM10 Exposure Distribution by Population Groups') %>%
  kable_styling_fc_wide()
```
